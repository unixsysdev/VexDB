# VxDB Kubernetes Deployment Configuration
# This configuration deploys all three VxDB services with production-ready settings

---
# Namespace for VxDB components
apiVersion: v1
kind: Namespace
metadata:
  name: vxdb
  labels:
    app: vxdb
    component: namespace

---
# ConfigMap for VxDB Insert Service configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vxinsert-config
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
data:
  config.yaml: |
    # VxDB Insert Service Configuration
    server:
      host: "0.0.0.0"
      port: 8080
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 60s
      max_header_bytes: 1048576
      shutdown_timeout: 30s
    
    logging:
      level: "info"
      format: "json"
      output: "stdout"
    
    metrics:
      enabled: true
      host: "0.0.0.0"
      port: 9091
      path: "/metrics"
      namespace: "vxdb"
      subsystem: "insert"
    
    cluster:
      name: "vxdb-cluster"
      data_dir: "/var/lib/vxdb/data"
      wal_dir: "/var/lib/vxdb/wal"
      snapshot_dir: "/var/lib/vxdb/snapshots"
    
    replication:
      enabled: true
      mode: "async"
      factor: 2
      timeout: 30s
    
    protocols:
      http:
        enabled: true
        port: 8080
        host: "0.0.0.0"
        base_path: "/api/v1"
        read_timeout: 30s
        write_timeout: 30s
        idle_timeout: 60s
        max_header_bytes: 1048576
        tls:
          enabled: false
        cors:
          enabled: true
          allowed_origins: ["*"]
          allowed_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          allowed_headers: ["*"]
          exposed_headers: ["*"]
          allow_credentials: true
          max_age: 86400
        compression:
          enabled: true
          level: 6
        rate_limit:
          enabled: true
          requests_per_second: 1000
          burst: 100
          by_ip: true
    
    auth:
      enabled: true
      type: "api_key"
      rate_limit:
        enabled: true
        requests_per_second: 1000
        burst: 100
        by_ip: true

---
# ConfigMap for VxDB Storage Service configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vxstorage-config
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
data:
  config.yaml: |
    # VxDB Storage Service Configuration
    server:
      host: "0.0.0.0"
      port: 8082
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 60s
      max_header_bytes: 1048576
      shutdown_timeout: 30s
    
    logging:
      level: "info"
      format: "json"
      output: "stdout"
    
    metrics:
      enabled: true
      host: "0.0.0.0"
      port: 9094
      path: "/metrics"
      namespace: "vxdb"
      subsystem: "storage"
    
    cluster:
      name: "vxdb-cluster"
      data_dir: "/var/lib/vxdb/data"
      wal_dir: "/var/lib/vxdb/wal"
      snapshot_dir: "/var/lib/vxdb/snapshots"
    
    storage:
      data_dir: "/var/lib/vxdb/storage"
      wal_dir: "/var/lib/vxdb/wal"
      temp_dir: "/var/lib/vxdb/temp"
      
      segment:
        max_vectors: 10000
        max_size: 104857600
        compression:
          enabled: true
          algorithm: "lz4"
          level: 6
        format_version: 1
        checksum:
          enabled: true
          algorithm: "crc32"
        sync_on_write: false
        preallocate: true
      
      memory_buffer:
        enabled: true
        max_size: 1073741824
        flush_interval: 5s
        flush_threshold: 0.8
        sync_on_flush: false
        compression:
          enabled: true
          algorithm: "lz4"
          level: 6
      
      cache:
        enabled: true
        type: "lru"
        size: 536870912
        ttl: 3600s
        eviction_policy: "lru"
    
    engine:
      search:
        max_results: 100
        default_k: 10
        timeout: 30s
        parallel_search: true
        max_concurrent_searches: 1000
        distance_metric: "cosine"
        normalize_vectors: true
        prefilter:
          enabled: true
          max_filters: 100
    
    grpc:
      enabled: true
      port: 9096
      host: "0.0.0.0"
      max_message_size: 4194304
      max_concurrent_streams: 1000
      connection_timeout: 30s
      tls:
        enabled: false

---
# ConfigMap for VxDB Search Service configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vxsearch-config
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
data:
  config.yaml: |
    # VxDB Search Service Configuration
    server:
      host: "0.0.0.0"
      port: 8083
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 60s
      max_header_bytes: 1048576
      shutdown_timeout: 30s
    
    logging:
      level: "info"
      format: "json"
      output: "stdout"
    
    metrics:
      enabled: true
      host: "0.0.0.0"
      port: 9097
      path: "/metrics"
      namespace: "vxdb"
      subsystem: "search"
    
    cluster:
      name: "vxdb-cluster"
      data_dir: "/var/lib/vxdb/data"
      wal_dir: "/var/lib/vxdb/wal"
      snapshot_dir: "/var/lib/vxdb/snapshots"
    
    engine:
      max_results: 100
      default_k: 10
      timeout: 30s
      parallel_search: true
      max_concurrent_searches: 1000
      distance_metric: "cosine"
      normalize_vectors: true
      prefilter:
        enabled: true
        max_filters: 100
    
    api:
      http:
        enabled: true
        port: 8083
        host: "0.0.0.0"
        base_path: "/api/v1"
        read_timeout: 30s
        write_timeout: 30s
        idle_timeout: 60s
        max_header_bytes: 1048576
        request_size_limit: 10485760
        tls:
          enabled: false
        cors:
          enabled: true
          allowed_origins: ["*"]
          allowed_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
          allowed_headers: ["*"]
          exposed_headers: ["*"]
          allow_credentials: true
          max_age: 86400
        compression:
          enabled: true
          level: 6
      
      grpc:
        enabled: true
        port: 9099
        host: "0.0.0.0"
        max_message_size: 4194304
        max_concurrent_streams: 1000
        connection_timeout: 30s
        tls:
          enabled: false
      
      response:
        include_query_vector: false
        include_metadata: true
        include_timestamps: true
        include_scores: true
        include_distances: true
        pretty_print: false
        max_results: 100
        response_timeout: 30s
    
    auth:
      enabled: true
      type: "api_key"
      rate_limit:
        enabled: true
        requests_per_second: 1000
        burst: 100
        by_ip: true
    
    routing:
      enabled: true
      strategy: "consistent_hash"
      hash_ring:
        virtual_nodes: 100
        replication_factor: 2
        hash_function: "murmur3"
      cache:
        enabled: true
        size: 1000
        ttl: 300s
    
    query_coordination:
      enabled: true
      strategy: "scatter_gather"
      timeout: 30s
      max_concurrent_queries: 1000
      parallel_execution: true
      result_merging:
        enabled: true
        strategy: "rank_fusion"
        deduplication: true
        scoring: true
        ranking: true
    
    cache:
      enabled: true
      type: "lru"
      size: 536870912
      ttl: 3600s
      eviction_policy: "lru"
      query_cache:
        enabled: true
        size: 268435456
        ttl: 300s
        max_query_length: 1000
      result_cache:
        enabled: true
        size: 268435456
        ttl: 600s
        max_results: 1000

---
# Secret for VxDB API keys and certificates
apiVersion: v1
kind: Secret
metadata:
  name: vxdb-secrets
  namespace: vxdb
  labels:
    app: vxdb
    component: secrets
type: Opaque
data:
  # Base64 encoded values (replace with actual values)
  # echo -n "your-api-key" | base64
  api-keys: "eW91ci1hcGkta2V5Cg=="
  tls-crt: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
  tls-key: "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K"

---
# Service for VxDB Insert Service
apiVersion: v1
kind: Service
metadata:
  name: vxinsert-service
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
spec:
  selector:
    app: vxdb
    component: vxinsert
  ports:
    - name: http
      port: 8080
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 9091
      targetPort: 9091
      protocol: TCP
    - name: dashboard
      port: 9092
      targetPort: 9092
      protocol: TCP
    - name: websocket
      port: 8081
      targetPort: 8081
      protocol: TCP
    - name: grpc
      port: 9093
      targetPort: 9093
      protocol: TCP
    - name: redis
      port: 6379
      targetPort: 6379
      protocol: TCP
  type: ClusterIP

---
# Service for VxDB Storage Service
apiVersion: v1
kind: Service
metadata:
  name: vxstorage-service
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
spec:
  selector:
    app: vxdb
    component: vxstorage
  ports:
    - name: http
      port: 8082
      targetPort: 8082
      protocol: TCP
    - name: metrics
      port: 9094
      targetPort: 9094
      protocol: TCP
    - name: dashboard
      port: 9095
      targetPort: 9095
      protocol: TCP
    - name: grpc
      port: 9096
      targetPort: 9096
      protocol: TCP
  type: ClusterIP

---
# Service for VxDB Search Service
apiVersion: v1
kind: Service
metadata:
  name: vxsearch-service
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
spec:
  selector:
    app: vxdb
    component: vxsearch
  ports:
    - name: http
      port: 8083
      targetPort: 8083
      protocol: TCP
    - name: metrics
      port: 9097
      targetPort: 9097
      protocol: TCP
    - name: dashboard
      port: 9098
      targetPort: 9098
      protocol: TCP
    - name: grpc
      port: 9099
      targetPort: 9099
      protocol: TCP
  type: ClusterIP

---
# Deployment for VxDB Insert Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vxinsert-deployment
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
spec:
  replicas: 3
  selector:
    matchLabels:
      app: vxdb
      component: vxinsert
  template:
    metadata:
      labels:
        app: vxdb
        component: vxinsert
    spec:
      serviceAccountName: vxdb-service-account
      containers:
        - name: vxinsert
          image: vxdb/vxinsert:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 9091
              name: metrics
            - containerPort: 9092
              name: dashboard
            - containerPort: 8081
              name: websocket
            - containerPort: 9093
              name: grpc
            - containerPort: 6379
              name: redis
          env:
            - name: VXDB_CONFIG_FILE
              value: "/etc/vxdb/config.yaml"
            - name: GIN_MODE
              value: "release"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config
              mountPath: /etc/vxdb
              readOnly: true
            - name: data
              mountPath: /var/lib/vxdb/data
            - name: wal
              mountPath: /var/lib/vxdb/wal
            - name: snapshots
              mountPath: /var/lib/vxdb/snapshots
            - name: buffer
              mountPath: /var/lib/vxdb/buffer
            - name: logs
              mountPath: /var/log/vxdb
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 1
      volumes:
        - name: config
          configMap:
            name: vxinsert-config
        - name: data
          persistentVolumeClaim:
            claimName: vxinsert-data-pvc
        - name: wal
          persistentVolumeClaim:
            claimName: vxinsert-wal-pvc
        - name: snapshots
          persistentVolumeClaim:
            claimName: vxinsert-snapshots-pvc
        - name: buffer
          persistentVolumeClaim:
            claimName: vxinsert-buffer-pvc
        - name: logs
          persistentVolumeClaim:
            claimName: vxinsert-logs-pvc

---
# Deployment for VxDB Storage Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vxstorage-deployment
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
spec:
  replicas: 3
  selector:
    matchLabels:
      app: vxdb
      component: vxstorage
  template:
    metadata:
      labels:
        app: vxdb
        component: vxstorage
    spec:
      serviceAccountName: vxdb-service-account
      containers:
        - name: vxstorage
          image: vxdb/vxstorage:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8082
              name: http
            - containerPort: 9094
              name: metrics
            - containerPort: 9095
              name: dashboard
            - containerPort: 9096
              name: grpc
          env:
            - name: VXDB_CONFIG_FILE
              value: "/etc/vxdb/config.yaml"
            - name: GIN_MODE
              value: "release"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config
              mountPath: /etc/vxdb
              readOnly: true
            - name: data
              mountPath: /var/lib/vxdb/data
            - name: wal
              mountPath: /var/lib/vxdb/wal
            - name: snapshots
              mountPath: /var/lib/vxdb/snapshots
            - name: storage
              mountPath: /var/lib/vxdb/storage
            - name: temp
              mountPath: /var/lib/vxdb/temp
            - name: manifest
              mountPath: /var/lib/vxdb/manifest
            - name: backups
              mountPath: /var/lib/vxdb/backups
            - name: logs
              mountPath: /var/log/vxdb
          resources:
            requests:
              memory: "1Gi"
              cpu: "1000m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8082
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8082
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 1
      volumes:
        - name: config
          configMap:
            name: vxstorage-config
        - name: data
          persistentVolumeClaim:
            claimName: vxstorage-data-pvc
        - name: wal
          persistentVolumeClaim:
            claimName: vxstorage-wal-pvc
        - name: snapshots
          persistentVolumeClaim:
            claimName: vxstorage-snapshots-pvc
        - name: storage
          persistentVolumeClaim:
            claimName: vxstorage-storage-pvc
        - name: temp
          persistentVolumeClaim:
            claimName: vxstorage-temp-pvc
        - name: manifest
          persistentVolumeClaim:
            claimName: vxstorage-manifest-pvc
        - name: backups
          persistentVolumeClaim:
            claimName: vxstorage-backups-pvc
        - name: logs
          persistentVolumeClaim:
            claimName: vxstorage-logs-pvc

---
# Deployment for VxDB Search Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vxsearch-deployment
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
spec:
  replicas: 3
  selector:
    matchLabels:
      app: vxdb
      component: vxsearch
  template:
    metadata:
      labels:
        app: vxdb
        component: vxsearch
    spec:
      serviceAccountName: vxdb-service-account
      containers:
        - name: vxsearch
          image: vxdb/vxsearch:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8083
              name: http
            - containerPort: 9097
              name: metrics
            - containerPort: 9098
              name: dashboard
            - containerPort: 9099
              name: grpc
          env:
            - name: VXDB_CONFIG_FILE
              value: "/etc/vxdb/config.yaml"
            - name: GIN_MODE
              value: "release"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          volumeMounts:
            - name: config
              mountPath: /etc/vxdb
              readOnly: true
            - name: data
              mountPath: /var/lib/vxdb/data
            - name: wal
              mountPath: /var/lib/vxdb/wal
            - name: snapshots
              mountPath: /var/lib/vxdb/snapshots
            - name: cache
              mountPath: /var/lib/vxdb/cache
            - name: logs
              mountPath: /var/log/vxdb
          resources:
            requests:
              memory: "1Gi"
              cpu: "1000m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8083
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8083
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 1
      volumes:
        - name: config
          configMap:
            name: vxsearch-config
        - name: data
          persistentVolumeClaim:
            claimName: vxsearch-data-pvc
        - name: wal
          persistentVolumeClaim:
            claimName: vxsearch-wal-pvc
        - name: snapshots
          persistentVolumeClaim:
            claimName: vxsearch-snapshots-pvc
        - name: cache
          persistentVolumeClaim:
            claimName: vxsearch-cache-pvc
        - name: logs
          persistentVolumeClaim:
            claimName: vxsearch-logs-pvc

---
# Service Account for VxDB services
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vxdb-service-account
  namespace: vxdb
  labels:
    app: vxdb
    component: service-account

---
# Role for VxDB services
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vxdb-role
  namespace: vxdb
  labels:
    app: vxdb
    component: role
rules:
  - apiGroups: [""]
    resources: ["pods", "services", "configmaps", "secrets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get", "list"]

---
# Role Binding for VxDB services
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vxdb-role-binding
  namespace: vxdb
  labels:
    app: vxdb
    component: role-binding
subjects:
  - kind: ServiceAccount
    name: vxdb-service-account
    namespace: vxdb
roleRef:
  kind: Role
  name: vxdb-role
  apiGroup: rbac.authorization.k8s.io

---
# Horizontal Pod Autoscaler for VxDB Insert Service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: vxinsert-hpa
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: vxinsert-deployment
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# Horizontal Pod Autoscaler for VxDB Storage Service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: vxstorage-hpa
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: vxstorage-deployment
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# Horizontal Pod Autoscaler for VxDB Search Service
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: vxsearch-hpa
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: vxsearch-deployment
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

---
# Persistent Volume Claims for VxDB Insert Service
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxinsert-data-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
    volume: data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxinsert-wal-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
    volume: wal
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxinsert-snapshots-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
    volume: snapshots
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxinsert-buffer-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
    volume: buffer
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxinsert-logs-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxinsert
    volume: logs
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
# Persistent Volume Claims for VxDB Storage Service
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-data-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-wal-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: wal
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-snapshots-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: snapshots
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-storage-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-temp-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: temp
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-manifest-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: manifest
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-backups-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: backups
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxstorage-logs-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxstorage
    volume: logs
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
# Persistent Volume Claims for VxDB Search Service
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxsearch-data-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
    volume: data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxsearch-wal-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
    volume: wal
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxsearch-snapshots-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
    volume: snapshots
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxsearch-cache-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
    volume: cache
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: vxsearch-logs-pvc
  namespace: vxdb
  labels:
    app: vxdb
    component: vxsearch
    volume: logs
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
# Ingress for VxDB services
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vxdb-ingress
  namespace: vxdb
  labels:
    app: vxdb
    component: ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - vxdb.example.com
      secretName: vxdb-tls
  rules:
    - host: vxdb.example.com
      http:
        paths:
          - path: /insert
            pathType: Prefix
            backend:
              service:
                name: vxinsert-service
                port:
                  number: 8080
          - path: /storage
            pathType: Prefix
            backend:
              service:
                name: vxstorage-service
                port:
                  number: 8082
          - path: /search
            pathType: Prefix
            backend:
              service:
                name: vxsearch-service
                port:
                  number: 8083